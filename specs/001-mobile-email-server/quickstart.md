# Quickstart Guide: MailRaven Email Server

**Feature**: 001-mobile-email-server  
**Date**: 2026-01-22  
**Audience**: System administrators setting up MailRaven for the first time

## Prerequisites

Before running the quickstart command:

1. **Linux Server**: Ubuntu 20.04+ or similar (2GB RAM, 2 CPU cores minimum)
2. **Public IP Address**: Server must be accessible from the internet
3. **Domain Name**: You must own a domain (e.g., `example.com`) with DNS control
4. **Root Access**: Sudo privileges for installing packages and configuring firewall
5. **Go 1.22+**: Required for building from source

## Step 1: Build MailRaven

```bash
# Clone repository
git clone https://github.com/mailraven/mailraven-server.git
cd mailraven-server

# Build binary (CGO-free)
CGO_ENABLED=0 go build -o mailraven cmd/mailraven/main.go

# Verify build
./mailraven version
# Output: MailRaven v1.0.0 (go1.22.0, linux/amd64)
```

## Step 2: Run Quickstart Command

The quickstart command generates configuration files and displays DNS records you need to create.

```bash
# Run quickstart with your email domain
sudo ./mailraven quickstart --domain example.com --admin-email admin@example.com

# You will be prompted to set an admin password
# Password must be at least 8 characters
```

**Quickstart Output**:

```
✓ Generated DKIM private key: /etc/mailraven/dkim.key
✓ Generated configuration file: /etc/mailraven/config.yaml
✓ Created data directory: /var/lib/mailraven
✓ Created admin user: admin@example.com

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  DNS RECORDS REQUIRED (Add these to your DNS provider)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. MX Record (Mail Exchange)
   Type: MX
   Name: @
   Value: mail.example.com
   Priority: 10
   TTL: 3600

2. A Record (Mail Server)
   Type: A
   Name: mail
   Value: 203.0.113.45 (your server IP)
   TTL: 3600

3. SPF Record (Sender Policy Framework)
   Type: TXT
   Name: @
   Value: v=spf1 a mx ip4:203.0.113.45 -all
   TTL: 3600

4. DKIM Record (DomainKeys Identified Mail)
   Type: TXT
   Name: mail._domainkey
   Value: v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
   TTL: 3600

5. DMARC Record (Domain-based Message Authentication)
   Type: TXT
   Name: _dmarc
   Value: v=DMARC1; p=none; rua=mailto:dmarc@example.com; pct=100
   TTL: 3600

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️  IMPORTANT: DNS propagation takes 5-60 minutes. 
   Wait for propagation before starting the server.

   Verify DNS with: dig MX example.com +short

✓ Quickstart complete! Review /etc/mailraven/config.yaml before starting.
```

## Step 3: Configure Firewall

Open required ports for SMTP and HTTPS:

```bash
# Allow SMTP (port 25) for receiving email
sudo ufw allow 25/tcp

# Allow HTTPS (port 443) for mobile API
sudo ufw allow 443/tcp

# Optional: Allow Prometheus metrics (port 9090)
sudo ufw allow 9090/tcp

# Enable firewall
sudo ufw enable
```

## Step 4: Add DNS Records

Copy the DNS records from quickstart output and add them to your DNS provider:

1. Log in to your DNS provider (e.g., Cloudflare, Route53, Namecheap)
2. Navigate to DNS management for `example.com`
3. Add all 5 DNS records (MX, A, SPF, DKIM, DMARC) exactly as shown
4. Save changes

**DNS Verification** (wait 10-30 minutes for propagation):

```bash
# Verify MX record
dig MX example.com +short
# Expected: 10 mail.example.com.

# Verify A record
dig A mail.example.com +short
# Expected: 203.0.113.45

# Verify SPF record
dig TXT example.com +short
# Expected: "v=spf1 a mx ip4:203.0.113.45 -all"

# Verify DKIM record
dig TXT mail._domainkey.example.com +short
# Expected: "v=DKIM1; k=rsa; p=MIIBIjAN..."

# Verify DMARC record
dig TXT _dmarc.example.com +short
# Expected: "v=DMARC1; p=none; rua=mailto:dmarc@example.com"
```

## Step 5: Review Configuration

Edit `/etc/mailraven/config.yaml` if you need to customize settings:

```yaml
# /etc/mailraven/config.yaml (generated by quickstart)

domain: example.com

ports:
  smtp: 25
  https: 443

storage:
  type: sqlite
  sqlite:
    path: /var/lib/mailraven/mail.db
    wal_mode: true
  blob_store:
    path: /var/lib/mailraven/messages
    compression: gzip

search:
  type: fts5

dkim:
  key_path: /etc/mailraven/dkim.key
  selector: mail

tls:
  cert_path: /etc/mailraven/tls.crt  # ⚠️ YOU MUST PROVIDE THIS
  key_path: /etc/mailraven/tls.key   # ⚠️ YOU MUST PROVIDE THIS

logging:
  level: info
  format: json

prometheus:
  enabled: true
  port: 9090
```

**⚠️ TLS Certificate Required**: Obtain TLS certificate for `mail.example.com` before starting server.

### Option A: Let's Encrypt (Recommended)

```bash
# Install certbot
sudo apt install certbot

# Obtain certificate (requires port 80 open temporarily)
sudo certbot certonly --standalone -d mail.example.com

# Certificate will be at:
# /etc/letsencrypt/live/mail.example.com/fullchain.pem
# /etc/letsencrypt/live/mail.example.com/privkey.pem

# Update config.yaml with certificate paths
sudo vim /etc/mailraven/config.yaml
# tls:
#   cert_path: /etc/letsencrypt/live/mail.example.com/fullchain.pem
#   key_path: /etc/letsencrypt/live/mail.example.com/privkey.pem
```

### Option B: Self-Signed Certificate (Testing Only)

```bash
# Generate self-signed certificate (valid 365 days)
sudo openssl req -x509 -newkey rsa:2048 -nodes \
  -keyout /etc/mailraven/tls.key \
  -out /etc/mailraven/tls.crt \
  -days 365 \
  -subj "/CN=mail.example.com"

# ⚠️ Self-signed certificates will trigger warnings in mobile apps
# Use Let's Encrypt for production
```

## Step 6: Start MailRaven Server

```bash
# Start server in foreground (for testing)
sudo ./mailraven serve --config /etc/mailraven/config.yaml

# Expected output:
# INFO Starting MailRaven email server version=1.0.0
# INFO SMTP listener started port=25
# INFO HTTPS API listener started port=443
# INFO Prometheus metrics enabled port=9090
# INFO Server ready domain=example.com
```

**For production**, use systemd service:

```bash
# Copy systemd service file
sudo cp deployment/mailraven.service /etc/systemd/system/

# Edit service file to set correct paths
sudo vim /etc/systemd/system/mailraven.service

# Enable and start service
sudo systemctl enable mailraven
sudo systemctl start mailraven

# Check status
sudo systemctl status mailraven

# View logs
sudo journalctl -u mailraven -f
```

## Step 7: Test Email Reception

Send a test email from Gmail/Outlook to `admin@example.com`:

```bash
# From another machine, use swaks (SMTP testing tool)
swaks --to admin@example.com \
  --from test@gmail.com \
  --server mail.example.com \
  --body "This is a test email to verify MailRaven is working."

# Expected output:
# <-  250 OK: Message accepted
```

**Check server logs**:

```bash
sudo journalctl -u mailraven -n 50
```

Look for log entries like:

```json
{
  "level": "info",
  "time": "2026-01-22T10:30:00Z",
  "session_id": "abc123",
  "remote_ip": "64.233.160.27",
  "sender": "test@gmail.com",
  "recipient": "admin@example.com",
  "message_id": "550e8400-e29b-41d4-a716-446655440000",
  "spf_result": "pass",
  "dkim_result": "pass",
  "dmarc_result": "pass",
  "msg": "Message accepted"
}
```

## Step 8: Test Mobile API

```bash
# Login to get JWT token
curl -X POST https://mail.example.com/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@example.com", "password": "your-password"}'

# Response:
# {
#   "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
#   "email": "admin@example.com",
#   "expires_at": "2026-01-29T10:00:00Z"
# }

# List messages (use token from login)
curl https://mail.example.com/api/v1/messages?limit=10 \
  -H "Authorization: Bearer eyJhbGci..."

# Response:
# {
#   "messages": [
#     {
#       "id": "550e8400-e29b-41d4-a716-446655440000",
#       "sender": "test@gmail.com",
#       "recipient": "admin@example.com",
#       "subject": "Test email",
#       "snippet": "This is a test email to verify...",
#       "read_state": false,
#       "received_at": "2026-01-22T10:30:00Z",
#       "spf_result": "pass",
#       "dkim_result": "pass",
#       "dmarc_result": "pass"
#     }
#   ],
#   "total": 1,
#   "limit": 10,
#   "offset": 0,
#   "has_more": false
# }
```

## Step 9: Configure Mobile App

In your MailRaven Android app, enter:

- **Server URL**: `https://mail.example.com`
- **Email**: `admin@example.com`
- **Password**: (your admin password from quickstart)

The app will:
1. Call `/api/v1/auth/login` to obtain JWT token
2. Call `/api/v1/messages` to fetch message list
3. Display inbox with received emails

## Troubleshooting

### DNS Issues

**Problem**: `dig MX example.com` returns nothing

**Solution**: 
- Wait longer for DNS propagation (can take 1 hour)
- Verify DNS records were added correctly in provider dashboard
- Check TTL settings (3600 = 1 hour cache)

### SMTP Connection Refused

**Problem**: Cannot connect to port 25

**Solution**:
- Check firewall: `sudo ufw status`
- Verify server is listening: `sudo netstat -tlnp | grep :25`
- Check server logs: `sudo journalctl -u mailraven -n 100`
- Some cloud providers (AWS, GCP) block port 25 by default - request to unblock

### TLS Certificate Errors

**Problem**: Mobile app shows "Certificate invalid"

**Solution**:
- Verify certificate is for correct domain: `openssl x509 -in /etc/mailraven/tls.crt -noout -subject`
- Check certificate expiration: `openssl x509 -in /etc/mailraven/tls.crt -noout -dates`
- Use Let's Encrypt instead of self-signed certificate

### SPF/DKIM Fails

**Problem**: Server logs show `spf_result: fail`

**Solution**:
- Verify SPF record exists: `dig TXT example.com +short`
- Check SPF syntax includes your server IP: `ip4:203.0.113.45`
- Verify DKIM selector matches config: `mail._domainkey.example.com`
- Test with mail-tester.com by sending to their test address

### Database Corruption

**Problem**: Server won't start, logs show "database disk image is malformed"

**Solution**:
```bash
# Stop server
sudo systemctl stop mailraven

# Check SQLite integrity
sqlite3 /var/lib/mailraven/mail.db "PRAGMA integrity_check;"

# If corruption detected, restore from backup
sudo cp /var/lib/mailraven/backup/mail.db /var/lib/mailraven/mail.db

# Start server
sudo systemctl start mailraven
```

## Next Steps

After successful quickstart:

1. **Setup Backups**: Configure daily backups of `/var/lib/mailraven/`
2. **Add Users**: Create additional mailboxes using `./mailraven user add user@example.com`
3. **Monitor Metrics**: View Prometheus metrics at `http://mail.example.com:9090/metrics`
4. **Configure Alerts**: Setup alerting for disk space, message queue, authentication failures
5. **Review Logs**: Configure log rotation in `/etc/logrotate.d/mailraven`

## Support

- **Documentation**: https://docs.mailraven.example.com
- **GitHub Issues**: https://github.com/mailraven/mailraven-server/issues
- **Community Forum**: https://community.mailraven.example.com

## Security Checklist

Before production deployment:

- [ ] TLS certificate from trusted CA (Let's Encrypt)
- [ ] Firewall configured (only ports 25, 443 open)
- [ ] Strong admin password (16+ characters)
- [ ] DNS records verified (SPF, DKIM, DMARC)
- [ ] Server time synchronized (NTP)
- [ ] Regular backups configured
- [ ] Log rotation configured
- [ ] Prometheus monitoring enabled
- [ ] Rate limiting tested
- [ ] Software updates automated
